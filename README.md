# M3U8 下载与广告剔除工具

## 简介 (Introduction)

本工具旨在提供一个便捷的方式来处理M3U8视频流。它可以从用户提供的文本文件中读取M3U8链接列表，下载相应的视频片段，并通过两种内置方法（分辨率变化检测和SSIM图像相似度对比）自动识别和标记广告片段。最后，工具会将非广告片段合并，并转换为常见的MP4格式，方便用户观看和存储。

## 功能特性 (Features)

*   **批量处理:** 支持从文本文件批量读取M3U8链接进行处理。
*   **自动目录创建:** 为每个视频流在指定的输出目录下自动创建以视频名称命名的子目录，用于存放下载的片段和相关临时文件。
*   **TS片段下载与重命名:** 下载M3U8视频流中的所有TS (Transport Stream) 片段，并按其在播放列表中的顺序重命名为 `0001.ts`, `0002.ts` 等格式。
*   **断点续传支持:** 在下载TS片段时，如果目标文件已存在，则会跳过下载，从而支持从上次中断的地方继续。
*   **广告检测方法1 (分辨率变化):** 记录视频流中第一个有效TS片段的视频分辨率。后续下载的片段如果分辨率与第一个片段不同，则被标记为广告片段。此方法具有较高优先级。
*   **广告检测方法2 (SSIM图像对比):**
    *   工具会提取用户指定的广告目录中所有视频文件的第一帧图像，作为广告样本库。
    *   对于下载的每一个TS片段，提取其第一帧图像。
    *   将该片段帧与广告样本库中的所有帧进行SSIM (Structural Similarity Index Measure) 图像相似度对比。
    *   如果与任一广告样本的相似度得分超过用户设定的阈值（默认为0.8），则该片段被标记为广告。
*   **SSIM性能优化 (帧缩放):** 为了提升SSIM广告检测的比较效率，在提取视频帧进行对比时，图片会被统一调整为320x180像素。
*   **自动合并与转换:** 在所有片段下载完成并进行广告检测后，工具会自动将所有未被标记为广告的TS片段按顺序合并，并最终转换为一个MP4文件。
*   **下载重试机制:** 在下载M3U8播放列表或单个TS片段时，如果发生超时或连接错误，工具会自动进行重试（默认最多尝试10次，每次重试前等待5秒）。
*   **可选的清理功能:** 用户可以通过命令行参数启用清理功能。若启用，在视频成功合并并转换为MP4格式后，脚本会自动删除该视频流下载的所有单个TS片段、合并产生的中间TS文件以及用于SSIM比对的临时帧图片。
*   **日志级别控制:** 支持通过命令行参数（`--log_level`）设置脚本运行时的日志输出级别（如DEBUG, INFO, WARNING, ERROR, CRITICAL），方便调试和追踪。

## 安装说明 (Installation)

### Python 环境:
*   需要 Python 3.6 或更高版本。

### 依赖库安装:
*   使用 pip 安装必要的 Python 库:
    ```bash
    pip install requests opencv-python scikit-image
    ```

### FFmpeg:
*   本工具依赖 FFmpeg 进行视频片段的合并与格式转换。请确保您的系统中已经正确安装了 FFmpeg。
*   **重要:** FFmpeg 的可执行文件路径需要被添加到系统的环境变量 `PATH` 中，这样脚本才能直接调用 `ffmpeg` 命令。
*   或者，如果 FFmpeg 未在系统 `PATH` 中，您也可以在运行脚本时通过 `--ffmpeg_path` 命令行参数来明确指定 `ffmpeg` 可执行文件的完整路径。

## 使用方法 (Usage)

### 命令行参数:
*   `-i INPUT_FILE, --input_file INPUT_FILE`:
    **(必需)** 指定一个文本文件路径，该文件包含M3U8视频链接。文件中的每一行应遵循特定格式：`视频名称$M3U8链接`。
*   `-o OUTPUT_DIR, --output_dir OUTPUT_DIR`:
    **(必需)** 指定一个目录路径，所有下载的视频片段、临时文件以及最终输出的MP4文件都将保存在此目录下。脚本会在此目录下为每个视频流创建相应的子目录。
*   `-a ADS_DIR, --ads_dir ADS_DIR`:
    **(必需)** 指定一个目录路径，该目录包含了用作广告识别参考的视频片段（例如，一些已知的广告视频文件）。工具会提取这些视频的首帧作为广告样本。
*   `-s SSIM_THRESHOLD, --ssim_threshold SSIM_THRESHOLD`:
    (可选) 设置SSIM图像相似度对比的阈值，用于判断一个片段是否为广告。该值应在0到1之间，值越高表示要求图像越相似才判断为广告。默认值为 `0.8`。
*   `--ffmpeg_path FFMPEG_PATH`:
    (可选) 手动指定 FFmpeg 可执行文件的完整路径。如果 `ffmpeg` 已在系统环境变量 `PATH` 中，则无需设置此参数。默认为 `ffmpeg`。
*   `--log_level {DEBUG,INFO,WARNING,ERROR,CRITICAL}`:
    (可选) 设置脚本运行期间的日志输出级别。可选级别包括 DEBUG, INFO, WARNING, ERROR, CRITICAL。默认为 `INFO`。
*   `--cleanup`:
    (可选) 若设置此参数，则在针对某个视频流的所有处理（包括MP4转换）成功完成后，脚本将自动删除该视频流下载的原始TS片段、合并生成的中间 `_merged.ts` 文件以及为SSIM分析提取的临时帧图片。

### 输入文件格式说明 (`input_file`):
*   输入文件是一个纯文本文件，每行代表一个需要下载和处理的M3U8视频源。
*   每行的格式严格遵循 `视频名称$M3U8链接` 的结构，其中 `$` 符号用作视频名称和M3U8链接之间的分隔符。
*   **示例:**
    ```
    电影A$https://example.com/path/to/movieA.m3u8
    剧集B$https://example.com/path/to/seriesB.m3u8
    测试视频$https://test.site/live/stream.m3u8
    ```

### 示例命令 (Example Command):
```bash
python m3u8_downloader.py -i my_videos.txt -o ./download_output -a ./my_ad_samples --ssim_threshold 0.85 --cleanup --log_level DEBUG
```
这条命令会：
1.  从 `my_videos.txt` 文件中读取视频列表。
2.  将所有下载内容和输出文件保存在 `./download_output` 目录下。
3.  使用 `./my_ad_samples` 目录中的视频作为广告识别的参考。
4.  设置SSIM相似度阈值为0.85。
5.  在MP4成功生成后，清理临时文件。
6.  将日志级别设置为DEBUG，以获取更详细的运行信息。

## 注意事项 (Notes)

*   **广告样本质量:** 广告目录 (`--ads_dir`) 中的视频片段应能有效代表真实广告的特征帧。样本的多样性和代表性会直接影响SSIM广告检测的准确率。
*   **SSIM阈值调整:** `--ssim_threshold` 参数的值可能需要根据实际视频内容和广告特性进行调整。如果阈值过高，可能漏检广告；如果过低，可能误将正常内容识别为广告。由于用于SSIM对比的帧图像已被统一调整为320x180像素以提高效率，这可能会影响SSIM值的整体分布，建议通过实验找到一个适合您场景的阈值。
*   **加密M3U8:** 此工具目前不支持处理经过加密（例如使用AES-128标准的HLS加密）的M3U8视频流。如果遇到此类视频流，下载和合并过程可能会失败。
*   **网络稳定性:** 视频下载过程受网络连接的稳定性影响。尽管工具内置了超时和重试机制（默认10次尝试，每次间隔5秒），但在极差的网络环境下仍可能导致下载失败。
*   **FFmpeg依赖:** 请务必确认FFmpeg已正确安装并配置，否则视频合并与转换步骤将无法执行。
